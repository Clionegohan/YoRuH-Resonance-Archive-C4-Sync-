---
id: "002-01-05"
epic_id: "002"
story_id: "002-01"
title: "セマンティック分割実装"
status: "pending"
created_at: "2026-01-02"
updated_at: "2026-01-03"
completed_at: null
revision_notes: "仕様改訂: 最大文字数600字に変更、Markdown構造対応、オーバーラップ追加、メタデータ充実"
---

# Subtask: セマンティック分割実装

## 親Story

[002-01: Phase 1 - Archive Synchronization](./002-01-phase1-archive-sync.md)

## 前提Subtask

- [002-01-04: Vaultスキャン実装](./002-01-04-vault-scanner.md) が完了していること

## ユーザーストーリー

> 開発者として、テキストを意味的なまとまりを保ちながら分割して、ベクトル化に適したチャンクを生成したい。なぜなら文脈を失わずにベクトル化したいから。

## Acceptance Criteria

### 基本動作

- [ ] **THE SYSTEM SHALL** テキストを意味的なまとまりを保ちながら分割し、`Chunk`オブジェクトのリストを返すこと

- [ ] **THE SYSTEM SHALL** 各チャンクが設定可能な最大文字数（デフォルト600文字）以内であること

- [ ] **THE SYSTEM SHALL** チャンク間に設定可能なオーバーラップ（デフォルト100文字）を持たせること

### 分割ルールの優先順位

以下の優先順位で分割を行うこと：

1. **THE SYSTEM SHALL** コードブロック（` ``` `で囲まれた領域）を保護し、内部を分割しないこと

2. **THE SYSTEM SHALL** Markdown水平線（`---`, `***`）または見出し（`#`, `##`等）を境界として分割すること

3. **THE SYSTEM SHALL** 段落単位（`\n\n`）で分割すること

4. **WHEN** チャンクが最大文字数を超える場合
   **THEN** システムは文単位（`。！？`）でさらに分割すること

5. **WHEN** 文分割後も最大文字数を超える場合
   **THEN** システムは句読点（`、`）またはスペースで分割すること

6. **WHEN** それでも最大文字数を超える場合
   **THEN** システムは最大文字数でハード分割し、オーバーラップを付けること

### チャンクメタデータ

- [ ] **THE SYSTEM SHALL** 各チャンクに以下のメタデータを付与すること：
  - `text`: チャンク本文
  - `start_offset`: 元テキストでの開始位置
  - `end_offset`: 元テキストでの終了位置
  - `seq`: チャンクの順序番号（0始まり）
  - `source_markers`: セクション見出しや構造マーカー（オプション）

### エッジケース

- [ ] **WHEN** 空テキストが入力された場合
      **THEN** システムは空リストを返すこと

- [ ] **WHEN** コードブロックが最大文字数を超える場合
      **THEN** システムはコードブロックを保護したまま1つのチャンクとして扱うこと（警告ログ出力）
